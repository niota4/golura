<div 
    class="chats-container"
    ng-init="initUserRooms()"
>
    <div class="chats">
        <div 
            class="grid-x align-top"
            ng-class="{'golura-mobile-block': $root.UI.isMobile, 'golura-block': !$root.UI.isMobile}"
        >
            <div class="cell small-12 medium-3 large-3 chats-sidebar"
                ng-class="{'golura-mobile-block': $root.UI.isMobile, 'golura-block': !$root.UI.isMobile}"
                ng-if="$root.UI.isMobile && !chatRoom.id || !$root.UI.isMobile"
            >
                <div class="chats-rooms list-container">
                    <div 
                        class="grid-y"
                        ng-class="{'golura-mobile-block': $root.UI.isMobile, 'golura-block': !$root.UI.isMobile}"
                    >
                        <div class="cell shrink">
                            <div class="chats-rooms-options-container">
                                <button 
                                    class="chat-create-room-button button success white-text" 
                                    ng-class="{'expanded': $root.UI.isMobile}"
                                    type="button"
                                    data-open="chatRoomFormReveal"
                                    ng-click="initChatRoomForm()"
                                >
                                    <i class="fal fa-layer-plus"></i> Create Chat
                                </button>
                            </div>
                        </div>
                        <div class="cell shrink">
                            <div class="chats-rooms-list-search list-search-container">
                                <div class="chats-rooms-list-search list-search">
                                    <div class="search-input-container">
                                        <div class="grid-x align-middle">
                                            <div class="cell auto align-self-bottom">
                                                <input 
                                                    class="search-input" 
                                                    type="text" 
                                                    placeholder="Search rooms..." 
                                                    ng-model="search.rooms" />
                                            </div>
                                            <div class="cell shrink align-self-bottom">
                                                <span class="search-icon">
                                                    <i class="fal fa-search"></i>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="cell auto">
                            <ul class="chats-rooms-list list">
                                <li 
                                    class="chats-rooms-list-item list-item"
                                    ng-repeat="room in chatRooms"  
                                    ng-click="initChatMessages(room)"
                                    ng-class="{'is-active': chatRoom.id == room.id}"
                                >
                                    <div format-users user="room.LastMessage.User"></div>
                                    <div class="grid-x grid-margin-x align-middle">
                                        <div 
                                            class="cell small-12 medium-12 large-auto"
                                            ng-if="!room.options"
                                        >
                                            <b>
                                                {{ room.name }} 
                                                <span 
                                                    class="badge alert white-text"
                                                    ng-if="room.unreadMessagesCount > 0"
                                                >
                                                    {{room.unreadMessagesCount}}
                                                </span>
                                            </b>
                                        </div>
                                        <div 
                                            class="cell small-12 medium-auto large-shrink"
                                            ng-if="room.LastMessage && !room.options"
                                        >
                                            <i>
                                                {{room.LastMessage.createdAt | TimeAgoFormat}}
                                            </i>
                                        </div>
                                        <div 
                                            class="cell auto"
                                            ng-if="room.options && !room.delete"
                                        >
                                            <div class="button-group expanded">                  
                                                <button
                                                    class="edit-button more-options-button button"
                                                    type="button"
                                                    ng-if="$root.user.id == room.Creator.id ||
                                                    subPermissions.adminSettings.canEdit"
                                                    ng-click="initChatRoomForm(room)"
                                                    data-open="chatRoomFormReveal"
                                                >
                                                    <i class="fal fa-edit"></i> Edit
                                                </button>
                                                <button
                                                    class="delete-button more-options-button button alert white-text"
                                                    type="button"
                                                    ng-if="subPermissions.adminSettings.canArchive"
                                                    ng-click="room.delete = !room.delete; room.options = false;"
                                                >
                                                    <i class="fal fa-archive"></i> Delete
                                                </button>
                                                <button 
                                                    class="more-options-button button warning white-text" 
                                                    type="button"
                                                    ng-click="room.options = !room.options"
                                                >
                                                    <i class="fal fa-times-circle"></i> Close
                                                </button>
                                            </div>
                                        </div>
                                        <div 
                                            class="cell small-shrink medium-shrink large-shrink"
                                            ng-if="!room.options && !$root.UI.isMobile"
                                        >
                                            <button 
                                                class="chats-rooms-options-button button clear"
                                                type="button"
                                                ng-click="room.options = !room.options;"
                                            >
                                                <i class="fal fa-ellipsis-v"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div format-messages message="room.LastMessage"></div>
                                    <p 
                                        ng-class="{'unread': room.unreadMessagesCount > 0}"
                                        ng-if="room.LastMessage && !room.options && !typingUsersByRoom[room.id].length"
                                    >
                                        <span>
                                            {{room.LastMessage.User.fullName}}:
                                        </span>
                                        <span 
                                            class="message-image"
                                            ng-if="room.LastMessage.imageUrls.length"
                                        >
                                            <i class="fal fa-image"></i>
                                        </span>
                                        <span ng-bind-html="room.LastMessage.formattedMessage">
                                        </span>
                                    </p>
                                    <div 
                                        class="typing-indicator" 
                                        ng-if="typingUsersByRoom[room.id].length && chatRoom.id !== room.id"
                                    >
                                        <span>
                                            <i class="fas fa-ellipsis"></i>
                                            <span ng-if="typingUsersByRoom[room.id].length === 1">
                                                <i>
                                                    {{typingUsersByRoom[chatRoom.id][0].firstName || 'Someone'}} is typing...
                                                </i>
                                            </span>
                                            <span ng-if="typingUsersByRoom[room.id].length > 1">
                                                <i>
                                                    Multiple people are typing...
                                                </i>
                                            </span>
                                        </span>
                                    </div>
                                    <p 
                                        class="chat-messages-empty"
                                        ng-if="!room.LastMessage"
                                    >
                                        There are no Messages in this Room
                                    </p>
                                    <div 
                                        class="charts-rooms-list-item-delete-container list-item-delete-container black-overlay"
                                        ng-if="room.delete"
                                    >
                                        <div class="button-group expanded">   
                                            <button 
                                                class="more-options-button list-item-options-button button alert white-text"
                                                type="button"
                                                ng-disabled="UI.formSaving"
                                                ng-class="{'form-alert': UI.formSaving}"
                                                ng-click="deleteChatRoom(room)"
                                            >
                                                <span ng-if="!UI.formSaving">
                                                    <i class="fal fa-check-circle"></i> Confirm
                                                </span>
                                                <span ng-if="UI.formSaving">
                                                    Please Wait...
                                                </span>
                                            </button>
                                            <button 
                                                class="more-options-button list-item-options-button button warning white-text"
                                                type="button"
                                                ng-click="room.delete = !room.delete"
                                            >
                                                <i class="fal fa-times-circle"></i> Cancel
                                            </button>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="chats-room-container golura-block cell small-12 medium-auto large-auto">
                <div 
                    class="chats-room-chat-preview-container"
                    ng-if="!chatRoom.id"
                >
                    <div class="chats-room-chat-preview">
                        <div class="chats-room-chat-preview-details-container text-center">
                            <div class="chats-room-chat-preview-details">
                                <div class="chats-room-chat-preview-icon-container">
                                    <i class="fad fa-comments"></i>
                                </div>
                                <h2>
                                    <span>
                                        <b>
                                            Click 
                                        </b>
                                        On a Chat to View it! Or Create a Chat
                                    </span>
                                </h2>
                            </div>
                        </div>
                    </div>
                </div>
                <div 
                    class="chats-room-chat-container"
                    ng-if="chatRoom.id"
                >
                    <div 
                        class="grid-y"
                        ng-class="{'golura-mobile-block': $root.UI.isMobile, 'golura-block': !$root.UI.isMobile}"
                    >
                        <div 
                            class="cell shrink"
                            ng-if="$root.UI.isMobile"
                        >
                            <div class="chats-room-chat-header-container">
                                <div class="chats-room-chat-header">
                                    <button 
                                        class="chat-room-back-button back-button button warning white-text" 
                                        ng-if="$root.UI.isMobile"
                                        type="button"
                                        ng-click="initChatMessages()"
                                    >
                                        <i class="fal fa-circle-arrow-left"></i>
                                    </button>
                                    <h3>
                                        {{chatRoom.name}}
                                    </h3>
                                </div>
                            </div>
                        </div>
                        <div class="cell auto">
                            <div 
                                ng-class="{'golura-mobile-block': $root.UI.isMobile, 'golura-block': !$root.UI.isMobile}"
                                ng-include="'/dist/partials/general/chats.html'"
                            ></div>
                        </div>
                        <div class="cell shrink">
                            <full-text-area 
                                placeholder="Write a message..."
                                ng-model="message.message" 
                                event-id="{{event.id || ''}}" 
                                chat-room-id="{{chatRoom.id || ''}}"
                                work-order-id="{{workOrder.id || ''}}" 
                                invoice-id="{{invoice.id || ''}}" 
                                events="events || []" 
                                work-orders="workOrders || []" 
                                invoices="invoices || []" 
                                message="{{message.id || ''}}"
                                user="{{user.id || ''}}"
                                users="users || []"
                                parent-chat-id="{{parentChat.id || ''}}"
                                parent-chat-text="{{parentChat.formattedMessage || ''}}"
                            >
                            </full-text-area>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div 
    class="chat-room-form-reveal reveal"
    id="chatRoomFormReveal"
    data-reveal
    data-close-on-click="false"
>
    <button 
        class="close-button" 
        aria-label="closeChatRoomFormReveal" 
        type="button" 
        data-close
    >
        <span aria-hidden="true">
            <i class="fal fa-times-circle"></i>
        </span>
    </button>
    <div ng-include="'dist/forms/chat/room-form.html'"></div>
</div>