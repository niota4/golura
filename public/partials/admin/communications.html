<div class="admin-communications-container admin-form-container">
    <div class="admin-communications admin-form-details">
        <div class="golura-block grid-y">
            <div class="cell shrink">
                <div class="admin-communications-options-container">
                    <h1 ng-if="communications.settings.setupComplete">
                        <b>
                            Communications Settings
                        </b>
                    </h1>
                </div>
            </div>
            <div 
                class="cell small-12 medium-auto large-auto"
                ng-if="!communications.settings.setupComplete"
            >
                <div class="admin-communication-setup-container grid-container text-center">
                    <h1>
                        <b>
                            Communications Not Set Up
                        </b>
                    </h1>
                    <p>
                        Complete your communications setup to start sending text messages to clients.
                    </p>
                    <button 
                        class="button success white-text"
                        type="button"
                        ng-class="{'form-saving': UI.communicationsOnboardingActive,
                        'expanded': $root.UI.isMobile}"
                        ng-click="initCommunicationsOnboarding()"
                        ng-disabled="UI.communicationsOnboardingActive"
                        data-open="communicationsPhoneSearchReveal"
                    >
                        <span ng-if="!UI.communicationsOnboardingActive">
                            <i class="fal fa-check-circle"></i> 
                            Start Setup
                        </span>
                        <span ng-if="UI.communicationsOnboardingActive">
                            Setting up...
                        </span>
                    </button>
                </div>
                </div>
            </div>
            <div 
                class="cell small-12 medium-auto large-auto"
                ng-if="communications.settings.setupComplete"
            >
                <div class="admin-communications-details-container">
                    <h2>
                        <b>
                            Communications Status
                        </b>
                    </h2>
                    <div class="grid-x grid-margin-x align-middle">
                        <div class="cell auto">
                            <p>
                                <b>Status:</b> 
                                <span class="badge success" ng-if="communications.settings.communicationsEnabled">
                                    <i class="fal fa-check-circle"></i> Active
                                </span>
                                <span class="badge warning" ng-if="!communications.settings.communicationsEnabled">
                                    <i class="fal fa-pause-circle"></i> Paused
                                </span>
                            </p>
                            <p ng-if="communications.settings.primaryPhoneNumber">
                                <b>Primary Number:</b> {{communications.settings.primaryPhoneNumber.number | tel}}
                            </p>
                        </div>
                        <div class="cell shrink">
                            <button 
                                class="button secondary tiny"
                                type="button"
                                ng-click="refreshCommunicationsSettings()"
                                ng-disabled="UI.communicationsRefreshing"
                            >
                                <i class="fal fa-sync-alt" ng-if="!UI.communicationsRefreshing"></i>
                                <i class="fal fa-spinner fa-spin" ng-if="UI.communicationsRefreshing"></i>
                                Refresh
                            </button>
                        </div>
                    </div>
                    <hr/>
                    <h2>
                        <b>
                            Usage Statistics
                        </b>
                    </h2>
                    <div class="grid-x grid-margin-x">
                        <div class="cell small-6">
                            <h6>This Month</h6>
                            <div class="stat-number">
                                {{communications.settings.monthlyUsed || 0}}
                            </div>
                            <small class="text-muted">Messages Sent</small>
                        </div>
                        <div class="cell small-6">
                            <h6>Remaining</h6>
                            <div class="stat-number">
                                {{(communications.settings.monthlyLimit || 1000) - (communications.settings.monthlyUsed || 0)}}
                            </div>
                            <small class="text-muted">Messages Available</small>
                        </div>
                    </div>
                    <div class="progress-container">
                        <div class="progress" role="progressbar" tabindex="0" aria-valuenow="{{((communications.settings.monthlyUsed || 0) / (communications.settings.monthlyLimit || 1000)) * 100}}" aria-valuemin="0" aria-valuemax="100">
                            <div class="progress-meter"></div>
                        </div>
                        <small class="text-muted">
                            {{((communications.settings.monthlyUsed || 0) / (communications.settings.monthlyLimit || 1000)) * 100 | number:1}}% of monthly limit used
                        </small>
                    </div>
                    <hr/>
                    <h2>
                        <b>
                            Phone Numbers
                        </b>
                    </h2>
                    <div class="grid-x grid-margin-x align-middle">
                        <div class="cell auto">
                            <p class="text-muted">Manage phone numbers for outbound communications</p>
                        </div>
                        <div class="cell shrink">
                            <button 
                                class="button success tiny"
                                type="button"
                                ng-click="initTwilioPhoneSearch()"
                            >
                                <i class="fal fa-phone"></i>
                                Get Phone Number
                            </button>
                        </div>
                        <div class="communications-phone-numbers-list" ng-if="communications.phoneNumbers.length">
                            <div 
                                class="communications-phone-number-item callout"
                                ng-repeat="phoneNumber in communications.phoneNumbers"
                                ng-class="{'primary': communications.settings.primaryPhoneNumber && phoneNumber.id === communications.settings.primaryPhoneNumber.id}"
                            >
                                <div class="grid-x grid-margin-x align-middle">
                                    <div class="cell auto">
                                        <div class="phone-number-info">
                                            <h6>{{phoneNumber.number | phone}}</h6>
                                            <div class="phone-number-meta">
                                                <span class="badge secondary">{{phoneNumber.type}}</span>
                                                <span class="badge success" ng-if="communications.settings.primaryPhoneNumber && phoneNumber.id === communications.settings.primaryPhoneNumber.id">
                                                    <i class="fal fa-star"></i> Primary
                                                </span>
                                                <span class="badge primary" ng-if="phoneNumber.isPurchased">
                                                    <i class="fal fa-cloud"></i> Twilio
                                                </span>
                                                <span class="badge secondary" ng-if="!phoneNumber.isPurchased">
                                                    <i class="fal fa-user"></i> Manual
                                                </span>
                                            </div>
                                            <div class="phone-number-capabilities" ng-if="phoneNumber.capabilities">
                                                <small class="text-muted">
                                                    <i class="fal fa-phone" ng-if="phoneNumber.capabilities.voice" title="Voice"></i>
                                                    <i class="fal fa-sms" ng-if="phoneNumber.capabilities.sms" title="SMS"></i>
                                                    <i class="fal fa-image" ng-if="phoneNumber.capabilities.mms" title="MMS"></i>
                                                    <i class="fal fa-fax" ng-if="phoneNumber.capabilities.fax" title="Fax"></i>
                                                </small>
                                            </div>
                                            <div class="phone-number-location" ng-if="phoneNumber.locality">
                                                <small class="text-muted">
                                                    <i class="fal fa-map-marker-alt"></i>
                                                    {{phoneNumber.locality}}, {{phoneNumber.region}} {{phoneNumber.postalCode}}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="cell shrink">
                                        <div class="button-group">
                                            <button 
                                                class="button warning tiny"
                                                type="button"
                                                ng-click="setPrimaryPhoneNumber(phoneNumber)"
                                                ng-if="!communications.settings.primaryPhoneNumber || phoneNumber.id !== communications.settings.primaryPhoneNumber.id"
                                                ng-disabled="UI.settingPrimary"
                                                title="Set as primary number"
                                            >
                                                <i class="fal fa-star"></i>
                                            </button>
                                            <button 
                                                class="button alert tiny"
                                                type="button"
                                                ng-click="releaseTwilioPhoneNumber(phoneNumber)"
                                                ng-if="phoneNumber.isPurchased"
                                                ng-disabled="UI.releasingNumber"
                                                title="Release Twilio number"
                                            >
                                                <i class="fal fa-times-circle"></i>
                                            </button>
                                            <button 
                                                class="button alert tiny"
                                                type="button"
                                                ng-click="removePhoneNumber(phoneNumber)"
                                                ng-if="!phoneNumber.isPurchased"
                                                ng-disabled="UI.removingPhoneNumber"
                                                title="Remove number"
                                            >
                                                <i class="fal fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div ng-if="!communications.phoneNumbers.length" class="text-center">
                            <p class="text-muted">
                                <i class="fal fa-phone-slash fa-2x"></i><br>
                                No phone numbers configured
                            </p>
                        </div>

                        <div class="cell small-12" ng-if="communications.settings.setupComplete">
                            <div class="card">
                                <div class="card-header">
                                </div>
                                <div class="card-body">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Communications Settings -->
                        <div class="cell small-12" ng-if="communications.settings.setupComplete">
                            <div class="card">
                                <div class="card-header">
                                    <h2>
                                        <i class="fal fa-cogs"></i>
                                        Settings
                                    </h2>
                                </div>
                                <div class="card-body">
                                    <form ng-submit="updateCommunicationsSettings($event, communications.settings)">
                                        <div class="grid-x grid-margin-x">
                                            <div class="cell small-12 medium-6">
                                                <label>
                                                    <input 
                                                        type="checkbox" 
                                                        ng-model="communications.settings.communicationsEnabled"
                                                    >
                                                    Enable Communications
                                                    <small class="help-text">Allow sending text messages to clients</small>
                                                </label>
                                            </div>
                                            <div class="cell small-12 medium-6">
                                                <label>
                                                    Monthly Message Limit
                                                    <input 
                                                        type="number"
                                                        ng-model="communications.settings.monthlyLimit"
                                                        min="100"
                                                        max="10000"
                                                        step="100"
                                                    >
                                                    <small class="help-text">Maximum messages per month</small>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="grid-x grid-margin-x">
                                            <div class="cell">
                                                <button 
                                                    class="button success"
                                                    type="submit"
                                                    ng-disabled="UI.settingsSaving"
                                                >
                                                    <i class="fal fa-save" ng-if="!UI.settingsSaving"></i>
                                                    <i class="fal fa-spinner fa-spin" ng-if="UI.settingsSaving"></i>
                                                    {{UI.settingsSaving ? 'Saving...' : 'Save Settings'}}
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Twilio Phone Number Search Modal -->
<div 
    class="communications-phone-number-search-reveal reveal form-reveal" 
    id="communicationsPhoneSearchReveal"
    data-reveal 
    data-close-on-click="false"
>
    <button 
        class="close-button" 
        aria-label="closeTwilioPhoneSearchReveal" 
        type="button" 
        data-close
    >
        <span aria-hidden="true">
            <i class="fal fa-times-circle"></i>
        </span>
    </button>
    <div 
        class="golura-block"
        ng-class="{'overflow-scroll': !$root.UI.isMobile}"
        ng-include="'dist/forms/admin/communications-phone-number-form.html'"
    ></div>
</div>
