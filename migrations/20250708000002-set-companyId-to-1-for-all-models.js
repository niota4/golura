'use strict';

module.exports = {
  up: async (queryInterface, Sequelize) => {
    // List of all tables that have companyId field
    const tablesWithCompanyId = [
      'activities',
      'addresses', 
      'blacklistedTokens',
      'chatMessages',
      'chatParticipants', 
      'chatPermissions',
      'chatRooms',
      'chatTypes',
      'clientActivities',
      'clientAddresses',
      'clientEmails',
      'clientNotes', 
      'clientPhoneNumbers',
      'clients',
      'companyIntegrations',
      'documents',
      'emailAddresses',
      'emails',
      'estimateActivities',
      'estimateAdjustments',
      'estimateFollowUps',
      'estimateHistories',
      'estimateLineItemImages',
      'estimateLineItemItems',
      'estimateLineItems', 
      'estimatePreferences',
      'estimates',
      'estimateSettings',
      'estimateSignatures',
      'estimateVersioning',
      'estimators',
      'estimatorUsers',
      'eventActivities',
      'eventCategories',
      'eventCheckins',
      'eventComments',
      'eventParticipants',
      'eventReminderTypes',
      'events',
      'formFolders',
      'forms',
      'formSubmissions',
      'formulas',
      'groupEventType',
      'groups',
      'images',
      'integrations',
      'inventoryAisles',
      'inventoryAreas',
      'inventoryAreaTypes',
      'inventoryItems',
      'inventoryLabels',
      'inventoryRacks',
      'inventoryRows',
      'inventorySections',
      'inventoryShelves',
      'invoiceHistories',
      'invoiceLineItems',
      'invoicePreferences',
      'invoices',
      'items',
      'labor',
      'lineItemItem',
      'lineItems',
      'marketing',
      'notifications',
      'payments',
      'payrollDeductions',
      'payrollItems',
      'payrolls',
      'phoneCalls',
      'phoneNumbers',
      'pricingApi',
      'purchaseOrderItems',
      'purchaseOrders',
      'questionContainers',
      'questions',
      'recurrencePatterns',
      'reminders',
      'roleGroups',
      'rolePermissions',
      'roles',
      'roleWidgets',
      'shortCodes',
      'templates',
      'textMessages',
      'toDos',
      'userCheckins',
      'userCredentials',
      'userDevices',
      'userDocuments',
      'userFolders',
      'userGroups',
      'userLastReadChats',
      'userPayRates',
      'userPermissions',
      'userPreferences',
      'userReminders',
      'userReminderTypes',
      'users',
      'userTwilio',
      'userWidgets',
      'variables',
      'vendorItems',
      'vendors',
      'videos',
      'warehouses',
      'workOrderActivities',
      'workOrderLineItems',
      'workOrders'
    ];

    // Set companyId = 1 for all existing records in each table
    for (const tableName of tablesWithCompanyId) {
      try {
        console.log(`Updating companyId for table: ${tableName}`);
        await queryInterface.sequelize.query(
          `UPDATE \`${tableName}\` SET companyId = 1 WHERE companyId IS NULL OR companyId = 0;`
        );
      } catch (error) {
        console.log(`Warning: Could not update table ${tableName}: ${error.message}`);
        // Continue with other tables even if one fails
      }
    }
  },

  down: async (queryInterface, Sequelize) => {
    // Reverse migration: set companyId back to NULL for all tables
    const tablesWithCompanyId = [
      'activities',
      'addresses', 
      'blacklistedTokens',
      'chatMessages',
      'chatParticipants', 
      'chatPermissions',
      'chatRooms',
      'chatTypes',
      'clientActivities',
      'clientAddresses',
      'clientEmails',
      'clientNotes', 
      'clientPhoneNumbers',
      'clients',
      'companyIntegrations',
      'documents',
      'emailAddresses',
      'emails',
      'estimateActivities',
      'estimateAdjustments',
      'estimateFollowUps',
      'estimateHistories',
      'estimateLineItemImages',
      'estimateLineItemItems',
      'estimateLineItems', 
      'estimatePreferences',
      'estimates',
      'estimateSettings',
      'estimateSignatures',
      'estimateVersioning',
      'estimators',
      'estimatorUsers',
      'eventActivities',
      'eventCategories',
      'eventCheckins',
      'eventComments',
      'eventParticipants',
      'eventReminderTypes',
      'events',
      'formFolders',
      'forms',
      'formSubmissions',
      'formulas',
      'groupEventType',
      'groups',
      'images',
      'integrations',
      'inventoryAisles',
      'inventoryAreas',
      'inventoryAreaTypes',
      'inventoryItems',
      'inventoryLabels',
      'inventoryRacks',
      'inventoryRows',
      'inventorySections',
      'inventoryShelves',
      'invoiceHistories',
      'invoiceLineItems',
      'invoicePreferences',
      'invoices',
      'items',
      'labor',
      'lineItemItem',
      'lineItems',
      'marketing',
      'notifications',
      'payments',
      'payrollDeductions',
      'payrollItems',
      'payrolls',
      'phoneCalls',
      'phoneNumbers',
      'pricingApi',
      'purchaseOrderItems',
      'purchaseOrders',
      'questionContainers',
      'questions',
      'recurrencePatterns',
      'reminders',
      'roleGroups',
      'rolePermissions',
      'roles',
      'roleWidgets',
      'shortCodes',
      'templates',
      'textMessages',
      'toDos',
      'userCheckins',
      'userCredentials',
      'userDevices',
      'userDocuments',
      'userFolders',
      'userGroups',
      'userLastReadChats',
      'userPayRates',
      'userPermissions',
      'userPreferences',
      'userReminders',
      'userReminderTypes',
      'users',
      'userTwilio',
      'userWidgets',
      'variables',
      'vendorItems',
      'vendors',
      'videos',
      'warehouses',
      'workOrderActivities',
      'workOrderLineItems',
      'workOrders'
    ];

    // Set companyId back to NULL for all tables
    for (const tableName of tablesWithCompanyId) {
      try {
        console.log(`Reverting companyId for table: ${tableName}`);
        await queryInterface.sequelize.query(
          `UPDATE \`${tableName}\` SET companyId = NULL WHERE companyId = 1;`
        );
      } catch (error) {
        console.log(`Warning: Could not revert table ${tableName}: ${error.message}`);
        // Continue with other tables even if one fails
      }
    }
  }
};
