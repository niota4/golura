const { DataTypes } = require('sequelize');

module.exports = {
  up: async (queryInterface, Sequelize) => {
    // Check if table already exists
    const tableExists = await queryInterface.showAllTables().then(tables => 
      tables.includes('Activities')
    );
    
    if (tableExists) {
      console.log('Activities table already exists, skipping creation');
      return;
    }

    await queryInterface.createTable('Activities', {
      id: {
        autoIncrement: true,
        type: DataTypes.INTEGER,
        allowNull: false,
        primaryKey: true
      },
      userId: {
        type: DataTypes.INTEGER,
        allowNull: false,
        references: {
          model: 'Users',
          key: 'id'
        },
        onUpdate: 'CASCADE',
        onDelete: 'RESTRICT'
      },
      activityType: {
        type: DataTypes.ENUM(
          'client', 'estimate', 'event', 'invoice', 'workOrder', 'purchaseOrder', 
          'user', 'role', 'permission', 'lineItem', 'payment', 'note', 'document',
          'communication', 'task', 'appointment', 'followUp', 'system'
        ),
        allowNull: false,
        comment: 'Type of entity this activity relates to'
      },
      entityId: {
        type: DataTypes.INTEGER,
        allowNull: true,
        comment: 'ID of the related entity (polymorphic relationship)'
      },
      action: {
        type: DataTypes.ENUM(
          'created', 'updated', 'deleted', 'viewed', 'approved', 'rejected', 
          'sent', 'received', 'completed', 'cancelled', 'scheduled', 'rescheduled',
          'assigned', 'unassigned', 'archived', 'restored', 'exported', 'imported',
          'logged_in', 'logged_out', 'status_changed', 'payment_received', 'payment_sent',
          'file_uploaded', 'file_deleted', 'email_sent', 'sms_sent', 'call_made',
          'note_added', 'comment_added', 'reminder_set', 'reminder_triggered'
        ),
        allowNull: false,
        comment: 'Action performed on the entity'
      },
      description: {
        type: DataTypes.TEXT,
        allowNull: true,
        comment: 'Human-readable description of the activity'
      },
      metadata: {
        type: DataTypes.JSON,
        allowNull: true,
        comment: 'Additional context data (before/after values, extra info)'
      },
      ipAddress: {
        type: DataTypes.STRING(45),
        allowNull: true,
        comment: 'IP address of the user who performed the action'
      },
      userAgent: {
        type: DataTypes.TEXT,
        allowNull: true,
        comment: 'User agent of the client that performed the action'
      },
      isSystemGenerated: {
        type: DataTypes.BOOLEAN,
        allowNull: false,
        defaultValue: false,
        comment: 'Whether this activity was generated by the system automatically'
      },
      severity: {
        type: DataTypes.ENUM('low', 'medium', 'high', 'critical'),
        allowNull: false,
        defaultValue: 'low',
        comment: 'Severity level of the activity for filtering and notifications'
      },
      isVisible: {
        type: DataTypes.BOOLEAN,
        allowNull: false,
        defaultValue: true,
        comment: 'Whether this activity should be visible in activity feeds'
      },
      tags: {
        type: DataTypes.JSON,
        allowNull: true,
        comment: 'Array of tags for categorization and filtering'
      },
      createdAt: {
        allowNull: false,
        type: DataTypes.DATE,
        defaultValue: Sequelize.literal('CURRENT_TIMESTAMP')
      },
      updatedAt: {
        allowNull: false,
        type: DataTypes.DATE,
        defaultValue: Sequelize.literal('CURRENT_TIMESTAMP')
      }
    });

    // Add indexes for better performance (with existence checks)
    try {
      await queryInterface.addIndex('Activities', ['userId'], {
        name: 'idx_activities_user_id'
      });
    } catch (err) {
      if (!err.message.includes('Duplicate key name')) throw err;
    }

    try {
      await queryInterface.addIndex('Activities', ['activityType', 'entityId'], {
        name: 'idx_activities_type_entity'
      });
    } catch (err) {
      if (!err.message.includes('Duplicate key name')) throw err;
    }

    try {
      await queryInterface.addIndex('Activities', ['action'], {
        name: 'idx_activities_action'
      });
    } catch (err) {
      if (!err.message.includes('Duplicate key name')) throw err;
    }

    try {
      await queryInterface.addIndex('Activities', ['createdAt'], {
        name: 'idx_activities_created_at'
      });
    } catch (err) {
      if (!err.message.includes('Duplicate key name')) throw err;
    }

    try {
      await queryInterface.addIndex('Activities', ['severity'], {
        name: 'idx_activities_severity'
      });
    } catch (err) {
      if (!err.message.includes('Duplicate key name')) throw err;
    }

    try {
      await queryInterface.addIndex('Activities', ['isVisible'], {
        name: 'idx_activities_visible'
      });
    } catch (err) {
      if (!err.message.includes('Duplicate key name')) throw err;
    }

    try {
      await queryInterface.addIndex('Activities', ['isSystemGenerated'], {
        name: 'idx_activities_system_generated'
      });
    } catch (err) {
      if (!err.message.includes('Duplicate key name')) throw err;
    }
  },

  down: async (queryInterface, Sequelize) => {
    await queryInterface.dropTable('Activities');
  }
};
