'use strict';

module.exports = {
  up: async (queryInterface, Sequelize) => {
    // List of all tables that need companyId field added
    const tablesWithCompanyId = [
      'activities',
      'addresses', 
      'blacklistedTokens',
      'chatMessages',
      'chatParticipants', 
      'chatPermissions',
      'chatRooms',
      'chatTypes',
      'clientActivities',
      'clientAddresses',
      'clientEmails',
      'clientNotes', 
      'clientPhoneNumbers',
      'clients',
      'companyIntegrations',
      'documents',
      'emailAddresses',
      'emails',
      'estimateActivities',
      'estimateAdjustments',
      'estimateFollowUps',
      'estimateHistories',
      'estimateLineItemImages',
      'estimateLineItemItems',
      'estimateLineItems', 
      'estimatePreferences',
      'estimates',
      'estimateSettings',
      'estimateSignatures',
      'estimateVersioning',
      'estimators',
      'estimatorUsers',
      'eventActivities',
      'eventCategories',
      'eventCheckins',
      'eventComments',
      'eventParticipants',
      'eventReminderTypes',
      'events',
      'formFolders',
      'forms',
      'formSubmissions',
      'formulas',
      'groupEventType',
      'groups',
      'images',
      'integrations',
      'inventoryAisles',
      'inventoryAreas',
      'inventoryAreaTypes',
      'inventoryItems',
      'inventoryLabels',
      'inventoryRacks',
      'inventoryRows',
      'inventorySections',
      'inventoryShelves',
      'invoiceHistories',
      'invoiceLineItems',
      'invoicePreferences',
      'invoices',
      'items',
      'labor',
      'lineItemItem',
      'lineItems',
      'marketing',
      'notifications',
      'payments',
      'payrollDeductions',
      'payrollItems',
      'payrolls',
      'phoneCalls',
      'phoneNumbers',
      'pricingApi',
      'purchaseOrderItems',
      'purchaseOrders',
      'questionContainers',
      'questions',
      'recurrencePatterns',
      'reminders',
      'roleGroups',
      'rolePermissions',
      'roles',
      'roleWidgets',
      'shortCodes',
      'templates',
      'textMessages',
      'toDos',
      'userCheckIns',
      'userCredentials',
      'userDevices',
      'userDocuments',
      'userFolders',
      'userGroups',
      'userLastReadChats',
      'userPayRates',
      'userPermissions',
      'userPreferences',
      'userReminders',
      'userReminderTypes',
      'users',
      'userTwilio',
      'userWidgets',
      'variables',
      'vendorItems',
      'vendors',
      'videos',
      'warehouses',
      'workOrderActivities',
      'workOrderLineItems',
      'workOrders'
    ];

    // Add companyId column to each table
    for (const tableName of tablesWithCompanyId) {
      try {
        console.log(`Adding companyId column to table: ${tableName}`);
        await queryInterface.addColumn(tableName, 'companyId', {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: {
            model: 'companies',
            key: 'id',
          },
          onUpdate: 'CASCADE',
          onDelete: 'SET NULL',
        });
        
        // Add index for better performance
        await queryInterface.addIndex(tableName, ['companyId'], {
          name: `${tableName}_companyId_index`
        });
        
      } catch (error) {
        console.log(`Warning: Could not add companyId to table ${tableName}: ${error.message}`);
        // Continue with other tables even if one fails (table might not exist yet)
      }
    }
  },

  down: async (queryInterface, Sequelize) => {
    // List of all tables that have companyId field
    const tablesWithCompanyId = [
      'activities',
      'addresses', 
      'blacklistedTokens',
      'chatMessages',
      'chatParticipants', 
      'chatPermissions',
      'chatRooms',
      'chatTypes',
      'clientActivities',
      'clientAddresses',
      'clientEmails',
      'clientNotes', 
      'clientPhoneNumbers',
      'clients',
      'companyIntegrations',
      'documents',
      'emailAddresses',
      'emails',
      'estimateActivities',
      'estimateAdjustments',
      'estimateFollowUps',
      'estimateHistories',
      'estimateLineItemImages',
      'estimateLineItemItems',
      'estimateLineItems', 
      'estimatePreferences',
      'estimates',
      'estimateSettings',
      'estimateSignatures',
      'estimateVersioning',
      'estimators',
      'estimatorUsers',
      'eventActivities',
      'eventCategories',
      'eventCheckins',
      'eventComments',
      'eventParticipants',
      'eventReminderTypes',
      'events',
      'formFolders',
      'forms',
      'formSubmissions',
      'formulas',
      'groupEventType',
      'groups',
      'images',
      'integrations',
      'inventoryAisles',
      'inventoryAreas',
      'inventoryAreaTypes',
      'inventoryItems',
      'inventoryLabels',
      'inventoryRacks',
      'inventoryRows',
      'inventorySections',
      'inventoryShelves',
      'invoiceHistories',
      'invoiceLineItems',
      'invoicePreferences',
      'invoices',
      'items',
      'labor',
      'lineItemItem',
      'lineItems',
      'marketing',
      'notifications',
      'payments',
      'payrollDeductions',
      'payrollItems',
      'payrolls',
      'phoneCalls',
      'phoneNumbers',
      'pricingApi',
      'purchaseOrderItems',
      'purchaseOrders',
      'questionContainers',
      'questions',
      'recurrencePatterns',
      'reminders',
      'roleGroups',
      'rolePermissions',
      'roles',
      'roleWidgets',
      'shortCodes',
      'templates',
      'textMessages',
      'toDos',
      'userCheckIns',
      'userCredentials',
      'userDevices',
      'userDocuments',
      'userFolders',
      'userGroups',
      'userLastReadChats',
      'userPayRates',
      'userPermissions',
      'userPreferences',
      'userReminders',
      'userReminderTypes',
      'users',
      'userTwilio',
      'userWidgets',
      'variables',
      'vendorItems',
      'vendors',
      'videos',
      'warehouses',
      'workOrderActivities',
      'workOrderLineItems',
      'workOrders'
    ];

    // Remove companyId column from each table
    for (const tableName of tablesWithCompanyId) {
      try {
        console.log(`Removing companyId column from table: ${tableName}`);
        
        // Remove index first
        await queryInterface.removeIndex(tableName, `${tableName}_companyId_index`);
        
        // Remove column
        await queryInterface.removeColumn(tableName, 'companyId');
        
      } catch (error) {
        console.log(`Warning: Could not remove companyId from table ${tableName}: ${error.message}`);
        // Continue with other tables even if one fails
      }
    }
  }
};
